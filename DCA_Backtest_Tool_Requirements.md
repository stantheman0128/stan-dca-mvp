# 定期定額策略回測工具 - 需求文檔

## 專案概述

### 核心目標
開發一個全功能的定期定額（DCA）投資策略回測與分析工具，用於研究和比較不同 DCA 策略優化方案的表現，並進行跨市場、跨時間的穩健性驗證。

### 專案背景
本專案作為申請優式資本儲備交易員計畫的研究成果展示，旨在證明：
1. 系統化的量化研究能力
2. 策略優化與驗證思維
3. 跨市場分析能力
4. 全棧開發能力
5. 數據驅動決策方法論

### 核心研究問題
**「如何在定期定額的基礎上，透過策略調整來改善風險調整後報酬？」**

子問題：
- 跌深加碼是否有效？效果如何量化？
- 趨勢過濾能否降低回撤？代價是什麼？
- 波動率調整是否改善夏普比率？
- 哪種優化策略在不同市場都表現穩健？
- 策略在極端市況（金融危機）下的保護能力如何？

---

## 技術架構

### 技術棧要求

**後端核心套件：**
```python
數據獲取與處理:
- yfinance: 股市數據獲取
- pandas: 數據處理
- numpy: 數值計算

視覺化:
- plotly: 互動式圖表（推薦）
- matplotlib: 靜態圖表（備選）

統計分析:
- scipy: 統計檢驗
- statsmodels: 進階統計（可選）

並行計算:
- concurrent.futures: 多線程

數據存儲:
- pickle: 測試結果序列化
- SQLite: 本地數據庫（可選）

報告生成:
- reportlab 或 weasyprint: PDF 生成
- openpyxl: Excel 導出
```

**前端框架：**
```
選項 A（推薦）: Streamlit
- 快速開發
- 內建 UI 組件
- 適合數據應用

選項 B: Dash
- 更專業外觀
- 更靈活客製化

選擇標準: 以快速開發為優先，確保功能完整
```

### 專案結構

```
dca_backtest_tool/
│
├── app.py                    # 主應用程式入口
├── requirements.txt          # 依賴套件列表
├── config.yaml              # 配置文件
├── README.md                # 專案說明
│
├── data/                    # 數據目錄
│   ├── cache/              # 緩存的歷史數據
│   └── user_data/          # 用戶上傳數據（可選）
│
├── strategies/              # 策略定義模組
│   ├── __init__.py
│   ├── base_strategy.py    # 基礎策略類
│   ├── dca_pure.py         # V0: 純定期定額
│   ├── dca_dip_buying.py   # V1: 跌深加碼
│   ├── dca_trend_filter.py # V2: 趨勢過濾
│   ├── dca_volatility.py   # V3: 波動率調整
│   ├── dca_valuation.py    # V4: 估值調整（可選）
│   └── dca_profit_taking.py # V5: 定期減碼（可選）
│
├── core/                    # 核心功能模組
│   ├── __init__.py
│   ├── data_loader.py      # 數據下載與緩存
│   ├── backtest_engine.py  # 回測引擎
│   ├── metrics.py          # 指標計算
│   ├── statistics.py       # 統計檢驗
│   └── visualizer.py       # 視覺化
│
├── utils/                   # 工具函數
│   ├── __init__.py
│   ├── helpers.py          # 輔助函數
│   ├── validators.py       # 數據驗證
│   └── report_generator.py # 報告生成
│
├── tests/                   # 單元測試（可選但推薦）
│   ├── test_strategies.py
│   ├── test_backtest.py
│   └── test_metrics.py
│
└── results/                 # 輸出目錄
    ├── reports/            # 生成的報告
    ├── exports/            # 導出的數據
    └── saved_tests/        # 保存的測試結果
```

---

## 完整功能需求

### 第一部分：核心回測功能

#### 1.1 數據管理

**功能：自動獲取與緩存歷史數據**

```yaml
數據來源: yfinance
數據範圍: 2005-12-23 至 2025-12-23（20年）

支援市場:
  美股:
    - SPY (S&P 500)
    - QQQ (Nasdaq 100)
    - DIA (Dow Jones)
    - IWM (Russell 2000)
  台股:
    - 0050.TW (元大台灣50)
    - 0056.TW (元大高股息)
    - ^TWII (加權指數)
  其他國際市場:
    - ^N225 (日經225)
    - ^FTSE (英國富時)
    - ^GDAXI (德國DAX)

數據字段:
  - Date: 日期
  - Open: 開盤價
  - High: 最高價
  - Low: 最低價
  - Close: 收盤價
  - Adj Close: 調整後收盤價（用於回測）
  - Volume: 成交量

緩存機制:
  - 首次下載後本地保存（pickle 或 CSV）
  - 自動檢查數據新鮮度
  - 每日更新最新數據
  - 手動刷新選項
  - 離線模式支援（使用緩存）

錯誤處理:
  - 下載失敗自動重試（3次）
  - 數據缺失值警告
  - 異常值檢測和處理
  - 用戶友善錯誤訊息
```

#### 1.2 策略定義

**必須實現的策略（至少前 3 個）：**

**V0: 純定期定額（基準線）**
```python
描述:
  最基本的定期定額策略，作為所有優化策略的對比基準
  
邏輯:
  每個投資週期固定投入相同金額
  不考慮市場狀況、價格高低
  
參數:
  - frequency: 投入頻率（週/月/季）
  - investment_amount: 每期投入金額（僅用於報酬率計算，實際可標準化）
  - start_date: 開始日期
  - end_date: 結束日期
  
計算流程:
  1. 根據頻率重採樣價格數據（取每期第一個交易日）
  2. 每期計算買入股數 = 投入金額 / 當期價格
  3. 累積持有股數
  4. 計算每期市值 = 累積股數 × 當期價格
  5. 計算累積成本和報酬率
```

**V1: 跌深加碼**
```python
描述:
  當價格相對近期高點大幅下跌時，增加投入金額
  
邏輯:
  - 追蹤過去 N 天的最高價
  - 計算當前價格相對高點的跌幅
  - 根據跌幅程度決定加碼倍數
  
參數:
  - lookback_period: 高點回顧期間（預設 252 交易日，約 1 年）
  - dip_threshold_1: 第一級跌幅閾值（預設 10%）
  - multiplier_1: 第一級加碼倍數（預設 1.5x）
  - dip_threshold_2: 第二級跌幅閾值（預設 20%）
  - multiplier_2: 第二級加碼倍數（預設 2.0x）
  
計算流程:
  1. 計算近期高點 = max(過去 lookback_period 的收盤價)
  2. 計算當前跌幅 = (近期高點 - 當前價格) / 近期高點
  3. 決定投入倍數:
     - if 跌幅 >= 20%: 投入金額 × 2.0
     - elif 跌幅 >= 10%: 投入金額 × 1.5
     - else: 投入金額 × 1.0
  4. 按調整後金額買入
  
注意事項:
  - 參數應可調整以測試敏感度
  - 可擴展為更多級別（3級、4級）
```

**V2: 趨勢過濾**
```python
描述:
  根據價格與長期移動平均線的關係調整投入
  價格低於均線時加碼（認為被低估）
  
邏輯:
  - 計算長期移動平均線（如 200 日均線）
  - 價格在均線下方時增加投入（逢低買入）
  - 價格在均線上方時正常投入
  
參數:
  - ma_period: 移動平均週期（預設 200）
  - ma_type: 移動平均類型（'SMA' 或 'EMA'，預設 SMA）
  - above_multiplier: 價格在 MA 上方時的投入倍數（預設 1.0）
  - below_multiplier: 價格在 MA 下方時的投入倍數（預設 1.5）
  
計算流程:
  1. 計算 MA_200 = 過去 200 日收盤價的簡單移動平均
  2. 決定投入倍數:
     - if 當前價格 < MA_200: 投入金額 × 1.5
     - else: 投入金額 × 1.0
  3. 按調整後金額買入
  
變化版本（可選）:
  - 使用 MACD、RSI 等其他技術指標
  - 使用多重均線（50/100/200 日）
```

**V3: 波動率調整（進階）**
```python
描述:
  根據市場波動率調整投入
  高波動（恐慌）時加碼，低波動時減碼
  
邏輯:
  - 計算滾動波動率（標準差）
  - 與歷史平均波動率比較
  - 高波動時加碼（市場恐慌是機會）
  
參數:
  - volatility_window: 波動率計算窗口（預設 20 日）
  - lookback_period: 歷史平均波動率計算期間（預設 252 日）
  - high_vol_threshold: 高波動閾值（預設 1.5 倍平均）
  - low_vol_threshold: 低波動閾值（預設 0.8 倍平均）
  - high_vol_multiplier: 高波動投入倍數（預設 1.5x）
  - low_vol_multiplier: 低波動投入倍數（預設 0.8x）
  
計算流程:
  1. 計算每日報酬率 = (今日收盤 - 昨日收盤) / 昨日收盤
  2. 計算當前波動率 = std(過去 20 日報酬率) × sqrt(252)
  3. 計算歷史平均波動率 = mean(過去 252 日的滾動波動率)
  4. 決定投入倍數:
     - if 當前波動率 > 1.5 × 平均: 投入 × 1.5
     - elif 當前波動率 < 0.8 × 平均: 投入 × 0.8
     - else: 投入 × 1.0
  5. 按調整後金額買入
```

**V4: 估值調整（可選，較複雜）**
```python
描述:
  根據估值指標調整投入（需要額外數據）
  
注意:
  此策略需要 PE ratio、PB ratio 等數據
  yfinance 可能不完全提供
  實現難度較高，優先級較低
  
可暫時跳過，或用簡化版本（如價格相對歷史百分位）
```

**V5: 定期減碼（可選）**
```python
描述:
  累積報酬達到目標時部分獲利了結
  
邏輯:
  - 追蹤累積報酬率
  - 達到閾值時賣出一定比例持股
  - 鎖定部分利潤
  
參數:
  - profit_threshold: 獲利閾值（預設 30%）
  - sell_percentage: 賣出比例（預設 30%）
  - reset_after_sell: 是否重置成本基礎（預設 false）
  
計算流程:
  1. 計算累積報酬率 = (當前市值 - 總成本) / 總成本
  2. if 累積報酬率 >= 30%:
     - 賣出持股 × 30%
     - 記錄實現利潤
     - 繼續定期投入
```

**策略實現要求：**
- 每個策略應繼承自基礎策略類
- 參數應可配置（透過 UI 或配置文件）
- 計算邏輯清晰，有註釋
- 可獨立測試

#### 1.3 回測引擎

**功能：高效準確的回測計算**

```python
核心功能:
  1. 接收策略配置和市場數據
  2. 逐期模擬投資過程
  3. 記錄完整交易歷史
  4. 計算績效指標
  
輸入:
  - strategy_config: 策略配置（類型、參數）
  - market_data: 市場價格數據（DataFrame）
  - start_date: 回測開始日期
  - end_date: 回測結束日期
  - frequency: 投資頻率（'W', 'M', 'Q'）
  - initial_capital: 初始資金（可選，預設 10,000）
  
處理流程:
  1. 數據預處理
     - 時間範圍篩選
     - 缺失值處理（forward fill）
     - 異常值檢測
     
  2. 時間重採樣
     - 根據頻率重採樣（週/月/季）
     - 確保在交易日執行（使用每期第一個交易日）
     
  3. 逐期模擬
     for each period:
       a. 獲取當期價格和市場狀態
       b. 調用策略計算投入金額
       c. 計算買入股數 = 投入金額 / 當期價格
       d. 更新累積持股
       e. 計算當前市值 = 累積股數 × 當期價格
       f. 記錄交易記錄和市值變化
       
  4. 計算績效指標
     - 調用 metrics 模組計算所有指標
     
輸出:
  BacktestResult 對象，包含:
    - transactions: 交易記錄 DataFrame
      [日期, 價格, 投入金額, 買入股數, 累積股數, 市值, 累積成本, 報酬率]
    - equity_curve: 權益曲線 DataFrame
      [日期, 市值, 累積成本, 報酬率]
    - metrics: 績效指標字典
    - strategy_config: 策略配置（用於記錄）
    
性能要求:
  - 單次回測 < 5 秒
  - 支援多線程批次回測
  - 記憶體使用合理（< 500 MB）
```

### 第二部分：分析與指標

#### 2.1 績效指標計算

**必須實現的指標：**

**報酬指標**
```python
1. 總報酬率（Total Return）
   公式: (最終市值 - 總投入) / 總投入 × 100%
   
2. 年化報酬率（CAGR - Compound Annual Growth Rate）
   公式: [(最終市值 / 總投入) ^ (1/投資年數)] - 1
   
3. 累積報酬（Absolute Return）
   公式: 最終市值 - 總投入
   
4. 每年報酬率（Annual Returns）
   計算每個日曆年度的報酬率
   輸出: 年份 → 報酬率的字典
   
5. 月度報酬率（Monthly Returns）
   計算每個月的報酬率（可選）
```

**風險指標**
```python
1. 最大回撤（Maximum Drawdown）
   定義: 從峰值到谷值的最大跌幅
   公式: max((峰值 - 谷值) / 峰值)
   
2. 最長回撤期間（Longest Drawdown Duration）
   定義: 從峰值跌落到恢復峰值的最長天數
   
3. 年化波動率（Annualized Volatility）
   公式: std(日報酬率) × sqrt(252)
   
4. 下行波動率（Downside Volatility）
   定義: 只計算負報酬的波動率
   公式: std(min(日報酬率, 0)) × sqrt(252)
   
5. 99% VaR（Value at Risk）
   定義: 最壞 1% 情況下的損失
   計算: 報酬率分佈的第 1 百分位數
```

**風險調整報酬**
```python
1. 夏普比率（Sharpe Ratio）
   公式: (年化報酬 - 無風險利率) / 年化波動率
   無風險利率預設: 2% (0.02)
   
2. 索提諾比率（Sortino Ratio）
   公式: (年化報酬 - 無風險利率) / 下行波動率
   優點: 只懲罰下行風險，不懲罰上行波動
   
3. 卡爾馬比率（Calmar Ratio）
   公式: 年化報酬 / 最大回撤
   解讀: 每承受 1% 回撤可獲得多少報酬
   
4. 資訊比率（Information Ratio，可選）
   公式: (策略報酬 - 基準報酬) / 追蹤誤差
   用於衡量相對基準的表現
```

**交易統計**
```python
1. 總交易次數
   = 投入次數（買入次數）
   
2. 平均持有成本
   = 總投入 / 總持股數
   
3. 當前持倉市值
   = 持股數 × 最新價格
   
4. 投資期間（月數/年數）
   
5. 勝率（可選）
   定義: 正報酬期間的比例
   計算: 報酬率 > 0 的天數 / 總天數
```

#### 2.2 統計檢驗

**功能：驗證策略差異的統計顯著性**

```python
必須實現:

1. 獨立樣本 t 檢驗（Independent t-test）
   目的: 比較兩個策略的報酬是否有顯著差異
   
   實現:
   from scipy import stats
   
   def compare_strategies_ttest(strategy_a_returns, strategy_b_returns):
       """
       比較兩個策略的報酬是否顯著不同
       
       Args:
           strategy_a_returns: 策略 A 的報酬序列（Series 或 array）
           strategy_b_returns: 策略 B 的報酬序列
           
       Returns:
           dict: {
               't_statistic': t 統計量,
               'p_value': p 值,
               'significant': 是否顯著 (p < 0.05),
               'conclusion': 文字結論
           }
       """
       t_stat, p_value = stats.ttest_ind(strategy_a_returns, strategy_b_returns)
       
       significant = p_value < 0.05
       conclusion = (
           f"策略差異{'顯著' if significant else '不顯著'} "
           f"(p = {p_value:.4f})"
       )
       
       return {
           't_statistic': t_stat,
           'p_value': p_value,
           'significant': significant,
           'conclusion': conclusion
       }
   
2. 信心區間（Confidence Interval）
   目的: 估計策略報酬的可信範圍
   
   計算 95% 信心區間:
   mean ± 1.96 × (std / sqrt(n))
   
   輸出: [下界, 上界]
   
3. 多策略比較（可選）
   如果比較多個策略，使用 Bonferroni 校正
   調整後的顯著水平 = α / 比較次數
   例如: 比較 3 個策略，α = 0.05 / 3 = 0.0167
```

#### 2.3 視覺化系統

**必須實現的圖表（使用 Plotly 互動式）：**

**圖表 1：權益曲線對比**
```python
功能:
  - 多策略權益曲線疊加在同一圖上
  - 顯示累積投入參考線（虛線）
  - 可選：顯示大盤 Buy & Hold 對比
  
X軸: 日期
Y軸: 市值（或報酬率）

互動功能:
  - hover 顯示: 日期、市值、報酬率
  - 圖例點擊隱藏/顯示特定策略
  - 縮放和平移
  - 時間範圍選擇器（range slider）

標註（可選）:
  - 重大金融事件垂直線標記
    · 2008/09/15 雷曼兄弟倒閉
    · 2020/03/23 疫情恐慌谷底
    · 2022/02/24 俄烏戰爭
  - 標註可 hover 顯示事件說明
```

**圖表 2：報酬率曲線**
```python
功能:
  - 累積報酬率百分比曲線
  - 零線參考（虛線）
  - 多策略對比
  
Y軸: 報酬率 (%)

視覺:
  - 正報酬區域填充淡綠色
  - 負報酬區域填充淡紅色

互動: 同圖表 1
```

**圖表 3：回撤曲線**
```python
功能:
  - 顯示權益相對峰值的回撤百分比
  - 多策略對比
  
Y軸: 回撤 (%)，範圍 [0, -100]

視覺:
  - 回撤區域填充紅色
  - 標註最大回撤點（annotation）

互動: 同圖表 1
```

**圖表 4：績效指標對比柱狀圖**
```python
功能:
  - 橫向柱狀圖比較不同策略的關鍵指標
  
指標包括:
  - 總報酬率
  - 年化報酬率
  - 最大回撤
  - 夏普比率
  
視覺:
  - 每個策略用不同顏色
  - 最佳值高亮顯示（如最高報酬、最低回撤）
```

**圖表 5：風險-報酬散點圖**
```python
功能:
  - X軸: 年化波動率（風險）
  - Y軸: 年化報酬率（報酬）
  - 每個點代表一個策略
  - 點的大小: 夏普比率（越大越好）
  
視覺輔助:
  - 左上角為「理想區域」（低風險高報酬）
  - 可添加 45 度效率前緣參考線
  - 大盤 Buy & Hold 用特殊標記
```

**其他圖表（優先級較低，可選）：**
- 年度報酬熱力圖
- 滾動報酬分佈箱型圖
- 參數敏感度曲面圖
- 月度報酬日曆熱力圖

### 第三部分：穩健性測試

#### 3.1 跨時間穩健性測試

**測試 A：固定起始點測試**
```python
功能:
  在預設的多個起始時間點執行回測
  觀察策略在不同市場週期的表現
  
預設測試點:
  - 2005-12-23 (完整 20 年)
  - 2008-01-01 (金融海嘯前)
  - 2009-03-01 (海嘯後谷底)
  - 2015-01-01 (中期)
  - 2020-01-01 (疫情前)
  - 2020-04-01 (疫情後)
  
流程:
  for each start_date:
    執行回測至 2025-12-23
    記錄績效指標
    
輸出:
  DataFrame: 起始日期 × 指標
  視覺化: 不同起始點的報酬率柱狀圖
  統計: 平均、最佳、最差起始點
```

**測試 B：Monte Carlo 隨機起始點模擬**
```python
功能:
  隨機選擇大量起始日期進行回測
  測試策略的時間穩健性
  
參數:
  - num_simulations: 模擬次數（預設 300）
  - min_duration_years: 最短投資期間（預設 3 年）
  - max_duration_years: 最長投資期間（預設 20 年）
  
流程:
  for i in range(300):
    隨機選擇起始日期（確保有足夠數據）
    隨機選擇投資期間（3-20 年）
    執行回測
    記錄報酬率和其他指標
    
並行計算:
  使用 concurrent.futures.ThreadPoolExecutor
  並行執行回測以加速（建議 4-8 線程）
  
進度顯示:
  實時進度條顯示已完成 / 總數
  預估剩餘時間
  
輸出:
  - 報酬率分佈直方圖
  - 統計摘要:
    · 平均報酬率
    · 中位數報酬率
    · 95% 信心區間
    · 最佳/最差情境
    · 勝率（正報酬的比例）
  - 可視化: 小提琴圖或箱型圖
```

**測試 C：滾動窗口分析**
```python
功能:
  使用固定時間窗口在整個歷史上滾動
  觀察策略在不同時期的穩定性
  
參數:
  - window_size: 窗口大小（1年/3年/5年/10年）
  - step_size: 滾動步長（預設 1 個月）
  
流程:
  start = 2005-12-23
  while start + window_size <= 2025-12-23:
    執行回測（start 到 start + window_size）
    記錄該窗口的報酬率
    start += step_size
    
範例（3年窗口，月度滾動）:
  2005-12 to 2008-12: 報酬率 = +15%
  2006-01 to 2009-01: 報酬率 = -5%
  2006-02 to 2009-02: 報酬率 = +2%
  ...
  2022-12 to 2025-12: 報酬率 = +25%
  
輸出:
  - 時間序列圖: 橫軸=窗口起始時間, 縱軸=該窗口報酬率
  - 統計: 所有窗口的平均、標準差、最大、最小
  - 觀察: 哪些時期策略表現好/差
```

#### 3.2 跨市場穩健性測試

**功能：在多個市場執行相同策略**

```python
測試市場清單:
  必測:
    - SPY (美國大盤)
    - QQQ (美國科技)
    - 0050.TW (台灣大盤)
  
  可選:
    - DIA (美國價值股)
    - IWM (美國小盤)
    - ^N225 (日本)
    - ^FTSE (英國)
    - ^GDAXI (德國)

流程:
  for each market:
    for each strategy:
      執行回測（2005-2025）
      記錄所有指標
      
對比維度:
  1. 絕對報酬率
  2. 風險調整後報酬（夏普比率）
  3. 最大回撤
  4. 與該市場 Buy & Hold 的相對表現
  
輸出:
  - 表格: 市場 × 策略 × 指標
  - 熱力圖: 視覺化不同市場的表現
  - 排名: 哪個策略在最多市場表現好
  - 穩健性評分: 標準差小 = 穩健
```

#### 3.3 參數敏感度分析

**功能：測試參數變化對結果的影響**

**單參數掃描**
```python
範例: V1 跌深加碼策略

測試 dip_threshold_1:
  參數值: [5%, 7%, 10%, 12%, 15%, 20%]
  其他參數固定
  
  for each value:
    設定 dip_threshold_1 = value
    執行回測
    記錄報酬率和夏普比率
    
輸出:
  - 折線圖: X軸=參數值, Y軸=報酬率
  - 折線圖: X軸=參數值, Y軸=夏普比率
  - 標註最優參數值
  - 敏感度評分: 曲線斜率（斜率大 = 敏感）

重複測試其他參數:
  - multiplier_1
  - lookback_period
```

**雙參數網格搜索（進階，可選）**
```python
範例: V1 兩個參數同時變化

參數空間:
  dip_threshold: [5%, 10%, 15%, 20%]
  multiplier: [1.2x, 1.5x, 2.0x, 2.5x]
  
總組合: 4 × 4 = 16 種

流程:
  for each (threshold, multiplier):
    執行回測
    記錄報酬率
    
輸出:
  - 熱力圖: X軸=threshold, Y軸=multiplier, 顏色=報酬率
  - 標註最優組合
  - 3D 曲面圖（可選）
```

### 第四部分：比較與分析

#### 4.1 多策略對比

**功能：並排比較多個策略**

```python
輸入:
  - 選擇的策略列表（2-6 個）
  - 市場
  - 時間範圍
  
輸出表格範例:

┌──────────────┬──────┬──────┬──────┬──────┬───────┐
│ 指標         │ V0   │ V1   │ V2   │ V3   │ 大盤  │
├──────────────┼──────┼──────┼──────┼──────┼───────┤
│ 總報酬率     │ 180% │ 220% │ 200% │ 195% │ 175%  │
│ 年化報酬率   │ 10.2%│ 12.8%│ 11.5%│ 11.1%│ 9.8%  │
│ 最大回撤     │ -33% │ -38% │ -28% │ -30% │ -35%  │
│ 夏普比率     │ 0.65 │ 0.72 │ 0.80 │ 0.75 │ 0.58  │
│ 索提諾比率   │ 0.89 │ 0.95 │ 1.05 │ 0.98 │ 0.80  │
│ 卡爾馬比率   │ 0.31 │ 0.34 │ 0.41 │ 0.37 │ 0.28  │
│ 勝率         │ 73%  │ 68%  │ 78%  │ 75%  │ 72%   │
└──────────────┴──────┴──────┴──────┴──────┴───────┘

視覺化:
  - 雷達圖: 多維度對比（6 個指標 × N 個策略）
  - 排名柱狀圖: 每個指標的策略排名
  - 高亮最佳策略（每個指標）

統計檢驗:
  對每對策略進行 t 檢驗
  輸出顯著性矩陣
```

#### 4.2 與大盤對比

**功能：策略 vs Buy & Hold**

```python
基準策略:
  Lump Sum（一次性投入）
  = 在起始日用所有資金買入並持有
  
計算:
  1. 初始買入股數 = 總投入 / 起始價格
  2. 最終市值 = 股數 × 最終價格
  3. 報酬率 = (最終市值 - 總投入) / 總投入
  
對比指標:
  1. 報酬率差異
     = DCA 策略報酬 - Buy & Hold 報酬
     
  2. Alpha（超額報酬，簡化版）
     = 策略報酬 - 預期報酬
     
  3. 相對表現比率
     = DCA 策略報酬 / Buy & Hold 報酬
     
視覺化:
  - 雙權益曲線: DCA vs Buy & Hold
  - 相對表現圖: (DCA / Buy & Hold) - 1
  - 標註領先/落後區間
```

#### 4.3 市況分析標註（可選但推薦）

**功能：標註重大金融事件**

```python
預設事件列表:
events = {
    '2008-09-15': '雷曼兄弟倒閉',
    '2008-10-10': '金融海嘯谷底',
    '2011-08-05': '美債降級',
    '2015-08-24': '中國股災',
    '2016-06-23': '英國脫歐',
    '2020-03-23': '疫情恐慌谷底',
    '2022-02-24': '俄烏戰爭',
    '2022-06-16': 'Fed 激進升息',
}

在圖表上:
  - 垂直虛線標註日期
  - hover 顯示事件說明
  - 可選擇顯示/隱藏
```

**牛熊市劃分（進階，可選）**
```python
定義:
  牛市: 從谷底上漲 > 20%
  熊市: 從峰值下跌 > 20%
  震盪: 其他時期
  
自動識別:
  分析大盤走勢
  標記牛熊轉換點
  
視覺化:
  圖表背景色:
    - 牛市: 淡綠色
    - 熊市: 淡紅色
    - 震盪: 白色或淡灰色
    
分析:
  統計策略在不同市況的表現
  輸出市況表現矩陣
```

### 第五部分：輸出與報告

#### 5.1 數據導出

**Excel 導出**
```python
生成多工作表 Excel 文件:

工作表 1: 概述 (Summary)
  - 測試配置摘要
  - 關鍵指標對比表
  - 最佳策略推薦
  
工作表 2: 詳細指標 (Metrics)
  - 所有策略的完整指標
  - 統計檢驗結果
  
工作表 3: 交易記錄 (Transactions)
  每筆投入的詳細記錄
  欄位: 日期 | 價格 | 投入金額 | 買入股數 | 累積持股 | 市值 | 累積成本 | 報酬率
  
工作表 4: 權益曲線 (Equity Curve)
  每日權益變化
  欄位: 日期 | 價格 | 市值 | 累積成本 | 報酬率
  
工作表 5: 統計檢驗 (Statistics)
  - t 檢驗結果
  - 信心區間
  - p-values
  
格式要求:
  - 標題行加粗
  - 數字格式化（千分位、百分比）
  - 條件格式（正報酬綠色、負報酬紅色）
  
套件: openpyxl
```

**CSV 導出（可選）**
```python
選項:
  - 權益曲線數據（用於進一步分析）
  - 績效指標摘要
  - 交易記錄
```

#### 5.2 PDF 報告生成

**自動化研究報告**

```python
報告結構（Markdown 格式）:

# 定期定額策略優化研究報告

## 執行摘要
- 研究目的
- 測試配置
- 關鍵發現（3-5 點，bullet points）
- 最佳策略推薦

## 1. 研究背景
- DCA 策略介紹
- 研究問題陳述

## 2. 測試方法
- 數據來源和範圍
- 回測參數設定
- 策略定義概述
- 評估指標說明

## 3. 回測結果

### 3.1 整體表現
[嵌入] 績效指標對比表
[嵌入] 權益曲線對比圖

### 3.2 風險分析
[嵌入] 回撤曲線圖
[嵌入] 風險指標表格

### 3.3 策略對比
[嵌入] 風險-報酬散點圖
[嵌入] 統計檢驗結果

## 4. 穩健性測試

### 4.1 跨時間穩健性
[嵌入] 不同起始點結果
[嵌入] Monte Carlo 模擬分佈圖

### 4.2 跨市場穩健性
[嵌入] 不同市場表現熱力圖

### 4.3 參數敏感度（可選）
[嵌入] 參數掃描圖

## 5. 關鍵發現

### 發現 1: [標題]
[詳細說明，支持數據]

### 發現 2: [標題]
...

## 6. 結論與建議
- 最佳策略推薦
- 適用情境說明
- 風險警示
- 未來研究方向（可選）

## 附錄
- 完整測試配置
- 計算公式
- 數據來源說明

生成選項:
  - PDF（推薦，使用 reportlab 或 weasyprint）
  - Markdown（可編輯）
  - HTML（互動版，可選）

客製化:
  - 選擇包含/排除特定章節
  - 選擇嵌入哪些圖表
  - 添加自定義備註
```

#### 5.3 測試結果管理

**保存測試結果**
```python
功能:
  將完整測試配置和結果序列化保存
  
保存內容:
  - 策略配置（類型、參數）
  - 市場和時間範圍
  - 完整回測結果（BacktestResult 對象）
  - 所有計算的指標
  - 圖表數據
  - 測試時間戳
  - 自定義標籤和備註
  
文件格式:
  使用 pickle 序列化
  文件命名: test_{timestamp}_{market}_{strategy}.pkl
  
存儲位置:
  results/saved_tests/
  
功能要求:
  - 用戶可命名測試（如「SPY_V1跌深加碼_2010起始」）
  - 添加標籤方便篩選
  - 記錄創建時間
```

**載入歷史測試**
```python
功能:
  瀏覽和載入已保存的測試
  
UI 功能:
  - 顯示已保存測試列表
  - 按日期/市場/策略篩選
  - 預覽測試摘要信息
  - 選擇載入
  - 刪除測試
  
載入後:
  - 顯示所有結果
  - 允許重新執行（更新數據）
  - 允許修改參數重測
```

**批次對比（進階，可選）**
```python
功能:
  選擇多個已保存測試進行橫向比較
  
用例:
  - 比較「不同參數版本」
  - 比較「不同時期測試」
  - 比較「不同市場測試」
  
輸出:
  - 並排對比表格
  - 對比圖表
  - 生成對比報告
```

---

## 用戶介面（UI）要求

### UI 框架選擇
**讓 AI Agent 自行選擇最適合的框架，建議優先考慮：**
- Streamlit（快速開發）
- Dash（專業外觀）
- Gradio（簡單互動）

### 核心 UI 功能要求

**基本輸入控制：**
```python
必須提供的輸入選項:
  1. 標的資產選擇（下拉選單或輸入框）
  2. 日期範圍選擇（日期選擇器）
  3. 投入頻率選擇（週/月/季）
  4. 策略選擇（多選，checkbox）
  5. 策略參數調整（數字輸入、滑桿等）
  6. 執行回測按鈕
```

**結果展示：**
```python
必須包含的展示區域:
  1. 關鍵指標卡片（大字顯示重要數字）
  2. 互動圖表區（可縮放、hover）
  3. 詳細指標表格（可排序、可篩選）
  4. 導出按鈕（Excel, PDF）
  5. 保存/載入測試功能
```

**用戶體驗：**
```python
基本要求:
  - 清楚的頁面標題和說明
  - 友善的錯誤訊息
  - 回測執行時的進度指示
  - 可取消長時間運算
  - 響應式布局（適應不同螢幕）
  
進階要求（可選）:
  - 工具提示說明（hover 顯示幫助）
  - 快速預設配置
  - 深色模式
```

**具體設計由 AI Agent 自行發揮，只要滿足上述功能要求即可。**

---

## 技術要求

### 性能要求

```python
響應時間目標:
  - 單次回測: < 5 秒
  - 300 次 Monte Carlo 模擬: < 2 分鐘（多線程）
  - 跨市場測試（5 市場 × 3 策略）: < 30 秒
  - 圖表渲染: < 2 秒
  - 數據首次下載: < 30 秒
  - 數據緩存讀取: < 1 秒

內存使用:
  - 基本運行: < 500 MB
  - 大量測試: < 2 GB
  - 數據緩存: < 100 MB

並行計算:
  使用多線程加速批次回測
  建議 4-8 個 worker
```

### 代碼品質要求

```python
可維護性:
  - 模組化設計（單一職責原則）
  - 清晰的函數命名（動詞 + 名詞）
  - 完整的 docstrings（Google Style 或 NumPy Style）
  - 類型提示（Type Hints）
  
範例:
def calculate_sharpe_ratio(
    returns: pd.Series,
    risk_free_rate: float = 0.02,
    periods_per_year: int = 252
) -> float:
    """
    計算夏普比率。
    
    Args:
        returns: 報酬率序列（日度或其他頻率）
        risk_free_rate: 年化無風險利率，預設 2%
        periods_per_year: 每年期數（日度=252, 月度=12）
        
    Returns:
        夏普比率（float）
        
    Raises:
        ValueError: 如果 returns 為空或全為 NaN
        
    Examples:
        >>> returns = pd.Series([0.01, 0.02, -0.01, 0.03])
        >>> sharpe = calculate_sharpe_ratio(returns)
        >>> print(f"Sharpe: {sharpe:.2f}")
    """
    if returns.empty or returns.isna().all():
        raise ValueError("Returns series is empty or all NaN")
    
    excess_returns = returns - risk_free_rate / periods_per_year
    sharpe = excess_returns.mean() / excess_returns.std() * np.sqrt(periods_per_year)
    
    return sharpe
```

**錯誤處理：**
```python
要求:
  - 所有可能失敗的操作都要 try-except
  - 錯誤訊息清楚易懂（告訴用戶怎麼修正）
  - 數據驗證（確保輸入合理）
  
範例:
try:
    data = yf.download(symbol, start=start_date, end=end_date)
    if data.empty:
        raise ValueError(f"No data available for {symbol}")
except Exception as e:
    error_msg = f"""
    ❌ 數據下載失敗
    
    標的: {symbol}
    錯誤: {str(e)}
    
    可能原因:
    • 網路連線問題
    • 標的代碼錯誤（請確認格式，如: SPY, 0050.TW）
    • 日期範圍無數據
    
    建議:
    1. 檢查網路連線
    2. 確認標的代碼正確
    3. 調整日期範圍
    4. 如有緩存，嘗試使用緩存數據
    """
    # 顯示友善錯誤訊息給用戶
```

### 單元測試（可選但強烈推薦）

```python
測試覆蓋範圍:
  - 策略邏輯測試（每個策略的買入邏輯）
  - 指標計算測試（驗證公式正確）
  - 數據處理測試（缺失值、異常值）
  - 邊界條件測試（空數據、單筆數據等）
  
範例測試用例:
def test_sharpe_ratio():
    """測試夏普比率計算"""
    # 已知答案的測試數據
    returns = pd.Series([0.1, 0.05, -0.02, 0.08, 0.12])
    sharpe = calculate_sharpe_ratio(returns, risk_free_rate=0.0)
    
    # 手動計算驗證
    expected_sharpe = returns.mean() / returns.std() * np.sqrt(252)
    
    assert abs(sharpe - expected_sharpe) < 1e-6, "Sharpe ratio calculation incorrect"
    
def test_dca_pure_strategy():
    """測試純定期定額策略"""
    # 創建模擬價格數據
    prices = pd.Series([100, 110, 105, 115, 120], 
                       index=pd.date_range('2020-01-01', periods=5, freq='M'))
    
    # 執行策略
    result = dca_pure_strategy(prices, monthly_invest=1000)
    
    # 驗證結果
    assert result['total_cost'] == 5000, "Total cost should be 5000"
    assert result['total_shares'] > 0, "Should have positive shares"
    assert result['final_value'] > 0, "Should have positive final value"
```

---

## 文檔要求

### README.md

```markdown
# DCA Strategy Backtesting Tool
定期定額策略回測工具

## 簡介
本工具用於回測和分析不同的定期定額（Dollar-Cost Averaging, DCA）投資策略變化，
並評估其在不同市場和時間條件下的穩健性。

## 功能特點
- ✅ 6 種 DCA 策略變化（純 DCA、跌深加碼、趨勢過濾等）
- ✅ 20 年歷史數據回測（2005-2025）
- ✅ 跨市場測試（美股、台股、國際市場）
- ✅ Monte Carlo 隨機模擬（300+ 次）
- ✅ 完整績效指標（報酬、風險、風險調整報酬）
- ✅ 互動式圖表（Plotly）
- ✅ 統計顯著性檢驗
- ✅ PDF/Excel 報告導出

## 快速開始

### 系統需求
- Python 3.8+
- 8GB RAM（推薦）
- 網路連線（用於下載數據）

### 安裝
```bash
# 克隆或下載本專案
git clone [repo_url]
cd dca_backtest_tool

# 安裝依賴
pip install -r requirements.txt
```

### 執行
```bash
# 啟動應用
python app.py

# 或如果使用 Streamlit
streamlit run app.py
```

然後在瀏覽器開啟顯示的 URL（通常是 http://localhost:8501）

## 使用指南

### 基本使用流程
1. 選擇標的資產（如 SPY）
2. 設定回測時間範圍
3. 選擇要測試的策略（可多選）
4. 調整策略參數（可選）
5. 點擊「開始回測」
6. 查看結果和圖表
7. 導出報告（PDF/Excel）

### 策略說明
- **V0 純定期定額**: 每期固定投入，不考慮市場狀況
- **V1 跌深加碼**: 價格大跌時增加投入
- **V2 趨勢過濾**: 價格低於均線時加碼
- **V3 波動率調整**: 高波動時加碼
- **V4 估值調整**: 根據估值指標調整（需額外數據）
- **V5 定期減碼**: 獲利達標時部分獲利了結

### 進階功能
- **穩健性測試**: 測試策略在不同時間點和市場的表現
- **Monte Carlo 模擬**: 隨機起始日期模擬 300+ 次
- **參數敏感度**: 測試參數變化的影響
- **統計檢驗**: 驗證策略差異的顯著性

## 專案結構
```
[貼上專案結構樹]
```

## 技術架構
- **數據來源**: Yahoo Finance (yfinance)
- **數據處理**: pandas, numpy
- **視覺化**: plotly（互動式圖表）
- **統計**: scipy（t檢驗等）
- **UI**: [Streamlit/Dash/其他]

## 常見問題

### Q: 數據下載失敗怎麼辦？
A: 檢查網路連線，確認標的代碼正確。如有緩存數據可使用離線模式。

### Q: 回測很慢怎麼辦？
A: 減少 Monte Carlo 模擬次數，或選擇較短的時間範圍。

### Q: 可以添加自定義策略嗎？
A: 可以！在 `strategies/` 目錄下創建新策略類，繼承 `BaseStrategy`。

### Q: 支援哪些市場？
A: 支援所有 Yahoo Finance 可查詢的市場，包括美股、台股、國際股市、ETF 等。

## 授權
MIT License

## 聯絡
[你的聯絡方式]
```

### requirements.txt

```
streamlit>=1.30.0
yfinance>=0.2.35
pandas>=2.0.0
numpy>=1.24.0
plotly>=5.18.0
scipy>=1.11.0
openpyxl>=3.1.0
reportlab>=4.0.0
```

---

## 優先級規劃

### P0 - 核心功能（必須完成）

```yaml
最高優先級:
  ✅ 數據下載與緩存機制
  ✅ 3 個基本策略實現（V0, V1, V2）
  ✅ 回測引擎（逐期模擬）
  ✅ 基礎指標計算（報酬率、夏普比率、最大回撤）
  ✅ 權益曲線圖（至少 1-2 個基本圖表）
  ✅ 簡單的 UI（能輸入參數、顯示結果）
  ✅ Excel 導出功能
  
可交付:
  一個可運行的 MVP
  能完成基本回測
  產出簡單報告
```

### P1 - 重要功能（強烈建議）

```yaml
重要功能:
  ✅ 完整 6 個策略（V0-V5，或至少 V0-V3）
  ✅ 完整指標體系（所有報酬和風險指標）
  ✅ 跨市場測試功能
  ✅ 固定起始點跨時間測試
  ✅ 統計檢驗（t-test）
  ✅ 多圖表視覺化（3-5 個圖表）
  ✅ PDF 報告生成
  ✅ 測試保存/載入功能
  
可交付:
  功能完整的專業工具
  適合申請使用
```

### P2 - 增強功能（加分項）

```yaml
加分功能:
  ☑️ Monte Carlo 隨機模擬（300次）
  ☑️ 滾動窗口分析
  ☑️ 參數敏感度分析
  ☑️ 年度/月度報酬分析
  ☑️ 更多風險指標（索提諾、卡爾馬等）
  ☑️ 金融事件標註
  
可交付:
  深度研究工具
  超出預期的展示
```

### P3 - 錦上添花（時間夠再做）

```yaml
可選功能:
  □ 策略組合（多策略混合）
  □ 牛熊市自動劃分
  □ 預設配置模板
  □ 批次測試對比
  □ 深色模式
  □ 更多圖表類型
```

---

## 測試驗證要求

### 功能驗證

```python
必須通過的測試:

1. 數據下載測試
   - 能成功下載 SPY 數據
   - 緩存機制正常工作
   - 錯誤處理友善
   
2. 策略執行測試
   - V0 純 DCA 正常運行
   - V1 跌深加碼邏輯正確
   - V2 趨勢過濾邏輯正確
   
3. 指標計算測試
   - 總報酬率計算正確
   - 年化報酬率計算正確
   - 夏普比率在合理範圍
   - 最大回撤 <= 100%
   
4. 完整流程測試
   - 用戶選擇配置 → 執行回測 → 顯示結果 → 導出報告
   - 整個流程無報錯
   - 5 秒內完成單次回測
```

### 數據正確性驗證

```python
手動驗證案例:

測試 1: 簡單情境
  數據: [100, 110, 120, 130, 140] (5期)
  策略: 純 DCA，每期投入 1000
  
  預期:
  - 第1期: 買10股，成本1000，市值1000
  - 第2期: 買9.09股，成本2000，市值2090
  - 第3期: 買8.33股，成本3000，市值3264
  - 第4期: 買7.69股，成本4000，市值4564
  - 第5期: 買7.14股，成本5000，市值5936
  - 總報酬率: (5936-5000)/5000 = 18.72%
  
  手動計算驗證程式輸出是否一致

測試 2: 跌深加碼
  數據: [100, 80, 70, 90, 100]
  策略: V1，閾值10%，倍數1.5x
  
  驗證加碼邏輯正確觸發
```

---

## 成功標準

### 最終交付檢查清單

```yaml
功能完整性:
  ✅ 核心回測功能正常運作
  ✅ 至少實現 V0, V1, V2 三個策略
  ✅ 關鍵指標計算正確
  ✅ 圖表清晰易讀
  ✅ 結果可導出（Excel + PDF）
  ✅ P0 全部完成，P1 至少 80% 完成

性能達標:
  ✅ 單次回測 < 5 秒
  ✅ UI 響應流暢（無明顯卡頓）
  ✅ 數據緩存有效
  
代碼品質:
  ✅ 模組化設計
  ✅ 關鍵函數有文檔
  ✅ 變數命名清楚
  ✅ 錯誤處理完善
  
申請材料就緒:
  ✅ 可生成專業 PDF 報告
  ✅ 有 3-5 個完整測試案例
  ✅ 有明確的研究發現
  ✅ README 完整
  ✅ 能在面試中流暢演示
```

---

## 風險提示與應對

```yaml
潛在風險 1: 數據下載不穩定
  應對:
    - 實現重試機制
    - 提供緩存備用
    - 友善錯誤提示

潛在風險 2: 計算時間過長
  應對:
    - 使用多線程
    - 優化算法（向量化計算）
    - 提供取消選項
    - 顯示進度條

潛在風險 3: UI 不夠直觀
  應對:
    - 提供使用說明
    - 添加工具提示
    - 參考主流工具設計

潛在風險 4: 圖表渲染慢
  應對:
    - 限制數據點數量（降採樣）
    - 使用高效圖表庫（Plotly）
    - 延遲加載（按需渲染）
```

---

## 最終交付清單

```yaml
代碼:
  ✅ 完整源代碼（清晰的目錄結構）
  ✅ requirements.txt（完整依賴列表）
  ✅ README.md（使用說明）
  ✅ config.yaml 或類似配置文件

測試結果:
  ✅ 3-5 個完整回測案例的輸出
  ✅ PDF 研究報告（3-5 頁）
  ✅ Excel 數據文件
  ✅ 截圖或演示影片（可選）

文檔:
  ✅ 使用說明（在 README 中）
  ✅ 策略說明（簡要）
  ✅ 技術架構說明（可選）
```

---

## 開發注意事項

1. **專注核心功能**：優先完成 P0，確保可用性
2. **數據品質第一**：確保回測結果準確，指標計算正確
3. **用戶體驗**：錯誤訊息友善，操作流程順暢
4. **代碼可讀性**：清晰的命名和註釋，便於未來維護
5. **性能優化**：使用向量化計算，避免慢速循環
6. **測試驗證**：手動驗證關鍵計算，確保邏輯正確

---

**本文檔提供完整的需求說明，AI Coding Agent 應根據此文檔開發系統，優先實現 P0 和 P1 功能，確保交付一個可用、準確、專業的定期定額策略回測工具。**
